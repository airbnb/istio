iptables -t nat -N ISTIO_INBOUND
iptables -t nat -N ISTIO_REDIRECT
iptables -t nat -N ISTIO_IN_REDIRECT
iptables -t nat -N ISTIO_OUTPUT
iptables -t nat -I PREROUTING 1 -i eth0 -j RETURN -m comment --comment "Kubevirt outbound redirect"
iptables -t nat -I PREROUTING 1 -i eth1 -j RETURN -m comment --comment "Kubevirt outbound redirect"
iptables -t nat -A ISTIO_INBOUND -p tcp --dport 15008 -j RETURN
iptables -t nat -A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001
iptables -t nat -A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006 -m comment --comment "redirect inbound request to proxy"
iptables -t nat -A PREROUTING -p tcp -j ISTIO_INBOUND -m comment --comment "direct all traffic through ISTIO_INBOUND chain"
iptables -t nat -A ISTIO_INBOUND -p tcp --dport 4000 -j ISTIO_IN_REDIRECT -m comment --comment "include inbound port for capture"
iptables -t nat -A ISTIO_INBOUND -p tcp --dport 5000 -j ISTIO_IN_REDIRECT -m comment --comment "include inbound port for capture"
iptables -t nat -A OUTPUT -p tcp -j ISTIO_OUTPUT -m comment --comment "direct all traffic through ISTIO_OUTBOUND chain"
iptables -t nat -A ISTIO_OUTPUT -o lo -s 127.0.0.6/32 -j RETURN
iptables -t nat -A ISTIO_OUTPUT -o lo ! -d 127.0.0.1/32 -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT
iptables -t nat -A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN
iptables -t nat -A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN
iptables -t nat -A ISTIO_OUTPUT -o lo ! -d 127.0.0.1/32 -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT
iptables -t nat -A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN
iptables -t nat -A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN
iptables -t nat -A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN
ip6tables -t nat -N ISTIO_INBOUND
ip6tables -t nat -N ISTIO_REDIRECT
ip6tables -t nat -N ISTIO_IN_REDIRECT
ip6tables -t nat -N ISTIO_OUTPUT
ip6tables -t nat -I PREROUTING 1 -i eth0 -j RETURN -m comment --comment "Kubevirt outbound redirect"
ip6tables -t nat -I PREROUTING 1 -i eth1 -j RETURN -m comment --comment "Kubevirt outbound redirect"
ip6tables -t nat -A ISTIO_INBOUND -p tcp --dport 15008 -j RETURN
ip6tables -t nat -A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001
ip6tables -t nat -A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006 -m comment --comment "redirect inbound request to proxy"
ip6tables -t nat -A PREROUTING -p tcp -j ISTIO_INBOUND -m comment --comment "direct all traffic through ISTIO_INBOUND chain"
ip6tables -t nat -A ISTIO_INBOUND -p tcp --dport 4000 -j ISTIO_IN_REDIRECT -m comment --comment "include inbound port for capture"
ip6tables -t nat -A ISTIO_INBOUND -p tcp --dport 5000 -j ISTIO_IN_REDIRECT -m comment --comment "include inbound port for capture"
ip6tables -t nat -A OUTPUT -p tcp -j ISTIO_OUTPUT -m comment --comment "direct all traffic through ISTIO_OUTBOUND chain"
ip6tables -t nat -A ISTIO_OUTPUT -o lo -s ::6/128 -j RETURN
ip6tables -t nat -A ISTIO_OUTPUT -o lo ! -d ::1/128 -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT
ip6tables -t nat -A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN
ip6tables -t nat -A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN
ip6tables -t nat -A ISTIO_OUTPUT -o lo ! -d ::1/128 -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT
ip6tables -t nat -A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN
ip6tables -t nat -A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN
ip6tables -t nat -A ISTIO_OUTPUT -d ::1/128 -j RETURN